#!/bin/bash
source "${KONIX_LIB_DIR}/lib_bash.sh"
findEmacsWindow () {
	wmctrl -l -x|grep -q emacs.Emacs
}

findEmacsclientProcess () {
	if on_windows_p
	then
		# no notion of emacs daemon on windows
		return 1
	else
		ps -A -o comm|grep -q '^emacsclient$'
	fi
}

findEmacsProcess () {
	if on_windows_p
	then
		ps -aW |grep -q 'emacs.exe'
	else
		ps -A -o comm|grep -q '^emacs$'
	fi
}

noNeedToCreateANewFrame ( ) {
	if konix_on_linux_p
	then
		if [ -n "$DISPLAY" ]
		then
			findEmacsWindow
		else
			return 0
		fi
	else
		if ! findEmacsProcess
		then
			source konix_assert.sh
		fi
	fi
}

startEmacsProcess ( ) {
	if on_windows_p
	then
		emacs.exe
	else
		emacs --daemon
	fi
}
if findEmacsProcess
then
	echo "Already an emacs daemon" 1>&2
else
	startEmacsProcess
fi

printf "Starting an emacsclient " 1>&2
if noNeedToCreateANewFrame
then
	printf "with no frame\n" >&2
	if [ -z "$@" ]
	then
		# Need at least an argument when launching without -c
		set "."
	fi
	emacsclient "$@"
else
	printf "within a new frame\n" >&2
	emacsclient -c "$@"
fi
