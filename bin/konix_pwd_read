#!/usr/bin/env python
# -*- coding:utf-8 -*-

import os
import sys
import tempfile
import subprocess
import re
import logging
logging.basicConfig(level=logging.DEBUG)

perso_dir = os.environ["PERSO_DIR"]
python_bin = os.environ["PYTHON_BIN"]
mdp_dir = os.path.join(perso_dir, "mdp_nd")
mdp_files = os.listdir(mdp_dir)
mdp_files.sort()
sys.stdout.write("List of MDP files\n")
cur_mdp_num=0
for fil in mdp_files:
        cur_mdp_num+=1
        sys.stdout.write(str(cur_mdp_num).rjust(5)+" "+fil+"\n")
sys.stdout.write("What mdp file to see ? ")
sys.stdout.flush()
res = raw_input("")
res=int(res)-1
mdp_file_name = os.path.join(mdp_dir, mdp_files[res])
if mdp_file_name.endswith(".gpg"):
        print "Decrypt file"
        mdp_file = tempfile.TemporaryFile()
        p = subprocess.Popen(["gpg", "-d", mdp_file_name],stdout=mdp_file)
        p.wait()
else:
        mdp_file = open(mdp_file_name,"r")
mdp_file.seek(0)
for line in mdp_file.readlines():
        login_match = re.match("^[Ll][Oo][Gg][Ii][Nn] *: *(.+)$",line)
        if login_match:
                print "Login :",login_match.group(1)
        match = re.match("^[Mm][dD][pP] *: *(.+)$", line)
        if match:
                mdp = match.group(1)
                p = subprocess.Popen(["konix_copy_to_clipboard", "Password"],stdin=subprocess.PIPE)
                p.stdin.write(mdp)
                p.stdin.close()
                break
mdp_file.close()
