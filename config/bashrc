#!/bin/bash

[ -z "$PS1" ] && return
source "$KONIX_CONFIG_DIR/shrc"

# make less more friendly for non-text input files
LESSPIPE="$(which lesspipe)"
[ -e "$LESSFILE" -a -x "$LESSFILE" ] && eval "$(lesspipe)"

# If this is an xterm set the title to user@host:dir
case "$TERM" in
xterm*|rxvt*)
    PROMPT_COMMAND='echo -ne "\033]0;${USER}@${HOSTNAME}: ${PWD/$HOME/~}\007"'
    ;;
*)
    ;;
esac

# ################################################################################
# Others
# ################################################################################
# ************************************************************
# Bash Comp
# ************************************************************
if [ -f /etc/bash_completion ]; then
    . /etc/bash_completion
fi

if [ -f /etc/profile.d/bash-completion.sh ]; then
    . /etc/profile.d/bash-completion.sh
fi

# source custom bash completions
OLD_IFS=$IFS
IFS=$'\n'
for bashcomp_file in $KONIX_CONFIG_DIR/bash-completion/*
do
	source "$bashcomp_file"
done
IFS=$OLD_IFS
# unset bash bmajor bminor

# by default autorise the core dump, till 200Mio
ulimit -c 209715200

# ######################################################################
# For a nice git prompt
# ######################################################################
source "${KONIX_DEVEL_DIR}/sjoubert_dot_rc/.config/bash/git"

# ************************************************************
# Variables
# ************************************************************
# Le prompt, joli et en couleur
#set -x
konix_string_to_color_index "$HOSTNAME"
konix_int_to_color "$RES" 0
HOST_COLOR="$RES"
konix_string_to_color_index "$LOGNAME"
konix_int_to_color "$RES" 0
LOGNAME_COLOR="$RES"
konix_int_to_color "$((COLOR_GREEN + 8))" "$COLOR_BLACK"
GIT_COLOR="$RES"
konix_int_to_color -1 -1
DEFAULT_COLOR="$RES"
konix_int_to_color $((COLOR_RED+8)) -1
BAD_PROMPT_COLOR="$RES"
konix_int_to_color $((COLOR_GREEN+8)) -1
GOOD_PROMPT_COLOR="$RES"
#set +x
export PS1="\$(rc=\$? && [ \$rc -ne 0 ] && printf '\[$BAD_PROMPT_COLOR\]' || printf '\[$GOOD_PROMPT_COLOR\]' ; printf '%03d$DEFAULT_COLOR' \$rc ;)\[$LOGNAME_COLOR\]\u\[\033[01;33;40m\]@\[$HOST_COLOR\]\h\[\033[00m\]\[\033[01;36;40m\]|path=\w|\[\033[00m\]${GIT_COLOR}\$(git_prompt)${DEFAULT_COLOR} \$(date \"+%H:%M:%S - %d/%m/%y\")\${KONIX_PROMPT_POST}\n\$ "
